#! /usr/bin/env -S stdbuf -oL -eL /bin/bash
# shellcheck shell=bash

set -euo pipefail
set -x

wd=$(dirname "$0")

src_root="$wd"

filter_redundant_monkeyc_warnings() {
    grep --line-buffered -v "^WARNING: .*: The launcher icon (128x128) isn't compatible with the specified launcher icon size of the device .*\. Image will be scaled to the target size" |
        grep --line-buffered -v "^WARNING: .*: Glance applications are not supported for app type 'watch-app' on device .*\. The (:glance) annotation will be ignored.$" ||
        true
}

exec > >(filter_redundant_monkeyc_warnings) 2>&1

. "$src_root/sdk-env.sh"

dev_devices=($(cat "$src_root/manifest.xml" | sed 's/iq://g' | xq -r '.manifest.application.products.product.[]|.["@id"]'))

release_resources="$src_root/release/resources"
mkdir -p "$release_resources"
release_source="$src_root/release/source"
mkdir -p "$release_source"

unmatchable='736fd2e'
source_version=$(git describe --match "$unmatchable" --dirty --always | sed 's/dirty/?/g')

beta_app_id="a3d8da80-e013-41f9-aca4-f66bb38fad3f"
prod_app_id="76526066-d191-46f4-9cfb-bbf9ed955b23"

sed -e "s/__SOURCE_VERSION__/$source_version/g" "$src_root"/local/resources/sourceVersion.xml-template >"$release_resources"/sourceVersion.xml
sed -e "s/__SOURCE_VERSION__/$source_version/g" "$src_root"/local/source/SourceVersion.mc-template >"$release_source"/SourceVersion.mc
sed -e "s/$beta_app_id/$prod_app_id/g" "$src_root"/manifest.xml >"$release_source"/manifest.xml

java -Xms1g -Dfile.encoding=UTF-8 -Dapple.awt.UIElement=true \
    -jar "$sdk_root"/bin/monkeybrains.jar \
    -o "$src_root/release/iq/WatchApp-prod.iq" \
    -f "$src_root/monkey-prod.jungle" \
    -y "$developer_key" \
    -e \
    -w

for device in "${dev_devices[@]}"; do
    java -Xms1g -Dfile.encoding=UTF-8 -Dapple.awt.UIElement=true \
        -jar "$sdk_root"/bin/monkeybrains.jar \
        -o "$src_root/release/$device/WatchApp-$device".prg \
        -f "$src_root/monkey-dev.jungle" \
        -y "$developer_key" \
        -d "$device" \
        -w
done
